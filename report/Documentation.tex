
%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[paper=a4, fontsize=11pt]{scrartcl} % A4 paper and 11pt font size

\usepackage[T1]{fontenc} % Use 8-bit encoding that has 256 glyphs
\usepackage{fourier} % Use the Adobe Utopia font for the document - comment this line to return to the LaTeX default
\usepackage[english]{babel} % English language/hyphenation
\usepackage{amsmath,amsfonts,amsthm} % Math packages

\usepackage{lipsum} % Used for inserting dummy 'Lorem ipsum' text into the template

\usepackage[utf8]{inputenc}

\usepackage{sectsty} % Allows customizing section commands
\allsectionsfont{\centering \normalfont\scshape} % Make all sections centered, the default font and small caps

\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage[linesnumbered,ruled]{algorithm2e}
\usepackage{multirow}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}

\usepackage{fancyhdr} % Custom headers and footers
\pagestyle{fancyplain} % Makes all pages in the document conform to the custom headers and footers
\fancyhead{} % No page header - if you want one, create it in the same way as the footers below
\fancyfoot[L]{} % Empty left footer
\fancyfoot[C]{} % Empty center footer
\fancyfoot[R]{\thepage} % Page numbering for right footer
\renewcommand{\headrulewidth}{0pt} % Remove header underlines
\renewcommand{\footrulewidth}{0pt} % Remove footer underlines
\setlength{\headheight}{13.6pt} % Customize the height of the header

\numberwithin{equation}{section} % Number equations within sections (i.e. 1.1, 1.2, 2.1, 2.2 instead of 1, 2, 3, 4)
\numberwithin{figure}{section} % Number figures within sections (i.e. 1.1, 1.2, 2.1, 2.2 instead of 1, 2, 3, 4)
\numberwithin{table}{section} % Number tables within sections (i.e. 1.1, 1.2, 2.1, 2.2 instead of 1, 2, 3, 4)

\setlength\parindent{0pt} % Removes all indentation from paragraphs - comment this line for an assignment with lots of text


%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\newcommand{\horrule}[1]{\rule{\linewidth}{#1}} % Create horizontal rule command with 1 argument of height

\title{	
\normalfont \normalsize 
\textsc{University of Zagreb, Faculty of Electronics and Computing} \\ [25pt] % Your university, school and/or department name(s)
\horrule{0.5pt} \\[0.4cm] % Thin top horizontal rule
\huge Computing optimal tresholds for q-gram filters \\ % The assignment title
\horrule{2pt} \\[0.5cm] % Thick bottom horizontal rule
}

\author{Stipe Kuman, Dino RadakoviÄ‡, Leon Rotim} % Your name

\date{\normalsize\today} % Today's date or a custom date

\begin{document}

\maketitle % Print the title

%----------------------------------------------------------------------------------------
%	PROBLEM 1
%----------------------------------------------------------------------------------------

\section{Introduction into the problem}

In this project we have analyzed and recreated a paper on the topic of finding optimal thresholds for q-gram filters. Q-gram filters
are used for matching substrings of length \textit{q} in a text with substrings in a given pattern. In addition, the paper we are recreating
uses gapped q-grams, which allow for discontinuous text substrings. Gapped q-grams were shown to be more efficient than 
contiguous q-grams in the right conditions. However, computing an optimal threshold for those filters is also more difficult. 
Our project was done in C++ and can run on the bio-linux platform.
In the next section we will describe the process we used in our computation. Before that, we will describe some of the main
principles our algorithm is based on.  % Introduction text


%------------------------------------------------

\subsection{Problem description}

First off, we will describe the notation used in this assignment. \textit{T} is the text file, \textit{P} is the given pattern and \textit{S} stands 
for all the substrings in \textit{T} that match the given pattern \textit{P} within a Hamming distance of \textit{k} (number of non-matching characters). 
The length of the q-gram filter is \textit{q} and the threshold is represented by \textit{t}. Finally, \textit{m} is the length of \textit{P} and \textit{S}. \\
The goal of the q-gram filter is to reduce the number of potential matches that need to be compared to the given pattern \textit{P}. 
The threshold variable \textit{t} defines the minimum number of q-gram matches between the pattern \textit{P} and 
a substring so that the substring would be considered as a potential match. A low value of \textit{t} will result in too many potential matches, 
while a too high value may overlook some potential matches which would make the filter lossy. Only filters that label all the matches as 
potential matches will be considered in the assignment.\\
As stated previously, this assignment will focus on gapped q-grams. For contiguous q-grams an optimal threshold can be computed with a
simple mathematical formula, which is not true for gapped q-gram filters. In gapped q-gram filters the problem is much more complex
because a closed form formula has not been found. Because of that we have used the dynamic algorithm found in the assignment paper.



%----------------------------------------------------------------------------------------

\subsection{Pruning method}
\label{subsec:pruning}

Even with this reasonably fast dynamic programming algorithm computing all
possible gapped Q-grams with positive threshold for parameters $m=50,\
k=\{4,5\}$ is still a challenging task. Using brute force method, calculating
threshold for all shapes in that have $m=50$ and $k=\{4,5\}$ and leaving only
those for which positive threshold is computed, would leave us with search space
of $2^{50} (\approx 10^{15}$) thresholds to compute. Since that kind of search
space is clearly unfeasible we use fallowing lemma as stated
in~\cite{njihovPaper} to reduce search space.

\begin{lemma}
    \label{subSetLemma}
    If $Q' \subseteq Q$ then $threshold_{Q'}(m,k) \geq threshold_{Q}(m,k)$
\end{lemma}

Using lemma~\ref{subSetLemma} we propose simple pruning technique which we used
while computing all Q-shapes with positive thresholds.

We introduce parameter $MS$ as a maximal span size of all Q-grams that will
considered. Obviously $MS \leq m$. This parameter is important because its value
drastically changes search space.

Let $Set_{current}$ be a set which contains all Q-grams with size $q$, which
respective thresholds had been computed.
Next we define two empty sets, $Set_{next}$ and $Set_{forbidden}$, which will
contain Q-grams of size $q+1$. After running pseudocode~\ref{alg:pruning}
$Set_{next}$ will contain all Q-grams of size $q+1$ that can not be eliminated
with lemma~\ref{subSetLemma}. 

\begin{algorithm}[H]
\caption{Generating candidate set of Q-grams which may have positive threshold}
\label{alg:pruning}
\underline{function generateNextCancidateSet} $(Set_{current}, MS)$\;
\SetKwInOut{Input}{Input}
\SetKwInOut{Output}{Output}

\Input{$Set_{current}$ - a set of Q-grams of size q, MS - maximal value of span
for all considered Q-grams}

\Output{$Set_{next}$ - set of Q-grams of size q+1 that can't be eliminated using
lemma~\ref{subSetLemma}}
\begin{algorithmic}
	 \STATE $Set_{next} \gets \emptyset$
	 \STATE $Set_{forbidden} \gets \emptyset$
     
     \FOR{each Q-gram $Q_{i} \in Set_{current}$}
         \FOR{ $i \in \{2,\dots,MS\} \setminus Q_{i}$ }
				 \STATE { $Q_{i}' = Q_{i} \cup i$
             	 	\IF{ threshold($Q_{i}$) ==  0 }
					\STATE { $Set_{next} \gets Set_{next} \setminus Q_{i}'$ }
	                \STATE { $Set_{forbidden} \gets Set_{forbidden} \cup Q_{i}'$ }
                    \ELSIF { $Q_{i}' \notin Set_{forbidden}$ }
                    \STATE { $Set_{next} \gets Set_{next} \cup Q_{i}'$ }
                    \ENDIF
                    }
         \ENDFOR
     \ENDFOR
\end{algorithmic}
return $Set_{next}$
\end{algorithm}

Using procedure~\ref{alg:pruning} we can compute thresholds for all Q-grams with
positive thresholds with $m=50$ and $k=\{4,5\}$ as presented in following
algorithm~\ref{alg:pruningLoop}.

\begin{algorithm}[H]
\caption{Pruning technique for computing all Q-grams with positive threshold}
\label{alg:pruningLoop}

\underline{function findAllQgramsWithPositiveThreshold } $(m,k,MS)$\;

\SetKwInOut{Input}{Input}

\Input{$m$ - size of a pattern, $k$ - number of miss-matches, $MS$ - maximal
value of span for all considered Q-grams}

\begin{algorithmic}
	\STATE $Set_{current} \gets \{Q_{start}\}$, where $Q_{start} = \{0\}$
	\WHILE{$Set_{current} \neq \emptyset}
		\FOR{each $Q_{i} \in Set_{current}$}
			\IF {threshold($Q_{i}$) > 0}
			\STATE add pair ($Q_{i}$, threshold($Q_{i}$)) to results
			\ENDIF
			\STATE $Set_{current} \gets$ generateNextCancidateSet($Set_{current}$, $MS$)
		\ENDFOR	
\end{algorithmic}

\end{algorithm}

Using this simple pruning method we drastically reduced search space by several
orders of magnitude. Leaving about $10^{8}$ thresholds to compute in order to
acquire all Q-shapes with positive thresholds with $m=50$ and $k=\{4,5\}$.

%TODO mozda prebacit u results ili tako nesto

Results obtained with this method are showed in tables~\ref{tab:res1}
and~\ref{tab:res2}. We note that tables do not contain threshold values for all
possible shapes. Even with this effective pruning technique number of thresholds
that has to be computed is still large. Due to the time limit and
shortage of computational power results are obtained with parameter $MS = 30$
(maximal span of considered Q-grams was $30$). Experiments were also ran with
$MS = 50$, however more time was needed to compute thresholds for Q-grams
with $q > 6$.

%----------------------------------------------------------------------------------------

\subsection{Results}

In this section we present results obtained with for Q-grams with $m=50$ and
$k=\{4,5\}$. Maximum values of thresholds in regard to Q-gram size ($q$) and
span are showed in tables~\ref{tab:res1} and~\ref{tab:res2}.

\begin{table}[H]
\centering
\begin{tabular} {|c|c|c|c|c|c|c|c|c|c|c|c|c|c|}
	\hline
	\multirow{ 2}{*}{Span} & \multicolumn{13}{|c|}{q} \\ 
	  & 2 &	3 & 4 &	5 & 6 & 7 & 8 & 9 &	10 & 11 & 12 & 13 & 14 \\ \hline
		%TODO kad dodu rezultati
\end{tabular}
\caption{Table showing maximal thresholds for Q-gram shapes with regard to
size($q$) and span of the shape for $m=50$ and $k=4$}
\label{tab:res1}
\end{table}

\begin{table}[H]
\centering
\begin{tabular} {|c|c|c|c|c|c|c|c|c|c|c|c|}
	\hline
	\multirow{ 2}{*}{Span} & \multicolumn{11}{|c|}{q} \\ 
	  & 2 &	3 & 4 &	5 & 6 & 7 & 8 & 9 &	10 & 11 & 12 \\ \hline
	2 & 39 & - & - & - & - & - & - & - & - & - & - \\
	3 & 38 & 33 & - & - & - & - & - & - & - & - & - \\
	4 & 37 & 32 & 27 & - & - & - & - & - & - & - & - \\
	5 & 36 & 31 & 26 & 21 & - & - & - & - & - & - & - \\
	6 & 35 & 30 & 25 & 20 & 15 & - & - & - & - & - & - \\
	7 & 34 & 29 & 24 & 19 & 14 & 9 & - & - & - & - & - \\
	8 & 33 & 28 & 23 & 18 & 13 & 8 & 3 & - & - & - & - \\
	9 & 32 & 27 & 22 & 18 & 14 & 9 & 5 & 0 & - & - & - \\
	10 & 31 & 26 & 21 & 18 & 13 & 10 & 6 & 3 & 0 & - & - \\
	11 & 30 & 25 & 20 & 16 & 13 & 10 & 7 & 4 & 2 & 0 & - \\
	12 & 29 & 24 & 19 & 16 & 12 & 9 & 7 & 4 & 2 & 0 & 0 \\
	13 & 28 & 23 & 19 & 15 & 12 & 9 & 6 & 4 & 2 & 1 & 0 \\
	14 & 27 & 22 & 17 & 14 & 11 & 8 & 6 & 4 & 2 & 1 & 0 \\
	15 & 26 & 21 & 17 & 13 & 10 & 8 & 5 & 3 & 2 & 1 & 0 \\
	16 & 25 & 20 & 16 & 13 & 10 & 7 & 5 & 3 & 2 & 1 & 0 \\
	17 & 24 & 19 & 15 & 12 & 9 & 7 & 5 & 3 & 2 & 1 & 0 \\
	18 & 23 & 18 & 14 & 11 & 8 & 6 & 4 & 3 & 2 & 1 & 0 \\
	19 & 22 & 17 & 14 & 11 & 8 & 6 & 4 & 2 & 1 & 1 & 1 \\
	20 & 21 & 16 & 13 & 10 & 7 & 5 & 3 & 2 & 1 & 1 & 0 \\
	21 & 20 & 15 & 12 & 9 & 7 & 5 & 3 & 2 & 1 & 0 & 0 \\
	22 & 19 & 15 & 12 & 9 & 6 & 4 & 2 & 1 & 1 & 0 & 0 \\
	23 & 18 & 15 & 12 & 9 & 6 & 4 & 2 & 1 & 0 & 0 & 0 \\
	24 & 18 & 15 & 13 & 9 & 7 & 4 & 2 & 1 & 0 & 0 & 0 \\
	25 & 19 & 15 & 13 & 9 & 7 & 4 & 3 & 1 & 1 & 0 & 0 \\
	26 & 20 & 15 & 14 & 9 & 8 & 5 & 3 & 2 & 1 & 0 & 0 \\
	27 & 19 & 14 & 14 & 9 & 9 & 6 & 4 & 2 & 1 & 1 & 0 \\
	28 & 18 & 13 & 13 & 8 & 8 & 5 & 4 & 3 & 2 & 1 & 0 \\
	29 & 17 & 12 & 12 & 8 & 8 & 5 & 5 & 2 & 2 & 1 & 0 \\
	30 & 16 & 11 & 11 & 7 & 6 & 4 & 4 & 2 & 2 & 1 & 0 \\
	31 & 15 & 10 & 10 & 7 & 7 & NP & NP & NP & NP & NP & NP \\
	32 & 14 & 10 & 9 & 7 & 5 & NP & NP & NP & NP & NP & NP \\
	33 & 13 & 11 & 8 & 6 & 6 & NP & NP & NP & NP & NP & NP \\
	34 & 12 & 11 & 7 & 6 & 6 & NP & NP & NP & NP & NP & NP \\
	35 & 11 & 11 & 6 & 6 & 6 & NP & NP & NP & NP & NP & NP \\
	36 & 10 & 10 & 6 & 5 & 5 & NP & NP & NP & NP & NP & NP \\
	37 & 9 & 9 & 7 & 4 & 4 & NP & NP & NP & NP & NP & NP \\
	38 & 8 & 8 & 7 & 4 & 3 & NP & NP & NP & NP & NP & NP \\
	39 & 7 & 7 & 7 & 4 & 3 & NP & NP & NP & NP & NP & NP \\
	40 & 6 & 6 & 6 & 4 & 2 & NP & NP & NP & NP & NP & NP \\
	41 & 5 & 5 & 5 & 5 & 3 & NP & NP & NP & NP & NP & NP \\
	42 & 4 & 4 & 4 & 4 & 3 & NP & NP & NP & NP & NP & NP \\
	43 & 3 & 3 & 3 & 3 & 3 & NP & NP & NP & NP & NP & NP \\
	44 & 2 & 2 & 2 & 2 & 2 & NP & NP & NP & NP & NP & NP \\
	45 & 1 & 1 & 1 & 1 & 1 & NP & NP & NP & NP & NP & NP \\
\end{tabular}
\caption{Table showing maximal thresholds for Q-gram shapes with regard to
size($q$) and span of the shape for $m=50$ and $k=5$}
\label{tab:res2}
\end{table}

%----------------------------------------------------------------------------------------

\subsection{Conclusion}

In order to compute optimal threshold for gapped q-grams we used efficient
dynamic programming algorithm and pruning technique as explained
in\ref{DPpoglavlje} and~\ref{subsec:pruning} respectively. Even though used DP
algorithm is much faster then running all possible miss-match combinations it
still has got superpolynomial time complexity with values of $m$ and $k$. 

%TODO nesto jos smislit..

\end{document}
